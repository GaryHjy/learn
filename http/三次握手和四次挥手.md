# 三次握手和四次挥手

- 三次握手

三次握手，简单来说是指当建立一个TCP连接时，整个建立过程需要客户端和服务端一共交互三个包，三次握手的目的是链接服务器的指定端口，建立TCP连接，并同步连接双方的序列号和确认号并交换TCP的窗口大小信息。

- 具体过程

**第一次握手**

开发建立连接时，客户端向服务器发出连接请求报文，报文首部中的同部位SYN = 1，同时选择一个初始序列号seq = x，这时客户端进程进入了SYN-SENT（同步已发送状态）状态，等待服务器确认。

**第二次握手**

服务器收到syn包后，如果同意连接，则发出确认报文；确认报文ACK = 1，SYN = 1，确认号是ack = x + 1，同时也要为自己初始化一个序列号seq = y，此时服务器进程进入了SYN-RCVD（同步收到）状态。

**第三次握手**

客户端收到服务器的SYN + ACK包，要向服务器给出确认。确认报文的ACK = 1，ack = y + 1，自己的序列号seq = x + 1。此时，TCP连接建立，客户端进入ESTABLISHED（已建立连接）状态。

- 四次挥手

TCP连接的终端需要客户端和服务端总共发送四个包，客户端或者服务器端均可主动发起挥手动作。

- 具体过程

**第一次挥手**

客户端进程发出连接释放报文，并且停止发送数据。释放数据报文首部FIN = 1，其序列号为seq = u（等于前面已经传送过来的数据最后一个字节的序号加1）。此时，客户端进入FIN-WAIT-1（终止等待1）状态。

**第二次挥手**

服务器收到连接释放报文，发出确认报文，ACK = 1，ack = u + 1，并且带上自己的序列号seq = v（客户端已经没有数据要发送了，但是服务器若发送数据，客户端依然要接受），此时，服务端进入了CLOSE-WAIT（关闭等待）状态。

**第三次挥手**

服务器将最后的数据发送完毕后，就向客户端发送连接中断报文，FIN = 1，ack = u + 1，由于在半关闭状态，服务器很可能又发送了一些数据，假定此时的序列号为seq = w，此时，服务器就进入了LAST-ACK（最后确认）状态，等待客户端的确认。

**第四次挥手**

客户端收到服务器的连接释放报文后，必须发出确认，ACK = 1，ack = w + 1，而自己的序列号seq = u + 1。此时，客户端就进入了TIME-WAIT（时间等待）状态。

服务器只要收到了客户端发出的确认，立即进入CLOSED状态。同样，撤销TCB后，就结束了这次的TCP连接（注意此时TCP连接还没有释放，必须经过2MSL（最长报文段寿命）的时间后，当客户端撤销响应的TCB后，才进入CLOSED状态）。服务器只要收到了客户端发出的确认，立即进入CLOSED状态。同样，撤销TCB后，就结束了这次的TCP连接。
